#!/usr/bin/env sh

set -e

# TODO(feat): Parse blacklist from ~/.config/todogrep/todogreprc
_watchlist() {
  find "$WHERE" -type f -not -path '\./\.git/*' -exec grep -Iq . {} \; -printf "%P\0"
}

# TODO(feat): Beautify column output.
# TODO(feat): Detect TODOs with empty type.
_todogrep() {
  _watchlist |
    xargs -0 grep -on 'TODO([^)]*):.*' |
    sed -e 's/^M$//' -e 's/\s\+$//g' |
    sed 's/^\(.*\):\([0-9]\+\):TODO(\([^)]\+\)):\s*\(.*\)/\3‡\1‡\2‡\4‡/g' |
    { printf '‡Type‡File‡Line‡What\n'; cat - ;} |
    column -t -s '‡'
}

[ -d "$1" ] && WHERE="$1" || WHERE='.'

case "$1" in
  -l|--watchlist)
    _watchlist | tr '\0' '\n'
    ;;
  *)
    _todogrep
    ;;
esac

# TODO(feat): cli arg for maxlen
# TODO(feat): README.md
# TODO(feat): Deal with more patterns:
#   - TODO          = not reconized
#   - TODO: ...     = not recognized
#   - TODO():       = breaks everything
# TODO(feat): Parallelize execution (xargs)
# TODO(feat): Read files to parse from stdin
